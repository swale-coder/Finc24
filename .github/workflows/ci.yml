name: Build ASP.NET WebApp

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2022

    steps:
      # Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4

      # Debugging steps (to confirm structure)
      - name: Print working directory
        run: pwd
      - name: List top-level files and folders
        run: dir
      - name: List all files recursively
        run: dir -Recurse

      # Setup build tools
      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Setup NuGet
        uses: NuGet/setup-nuget@v2

      - name: Restore NuGet packages
        run: nuget restore Finc24.sln

      # Build & publish
      - name: Build and Publish Web Project
        shell: pwsh
        run: |
          # Find the .csproj dynamically
          $projectPath = Get-ChildItem -Path . -Filter *.csproj -Recurse | Where-Object { $_.FullName -like "*Finc24.Web*" } | Select-Object -First 1 -ExpandProperty FullName
          if (-not $projectPath) {
            Write-Host "❌ ERROR: Could not find Finc24.Web.csproj"
            exit 1
          } else {
            Write-Host "✅ Found project: $projectPath"
          }

          # Run MSBuild with publish output
          msbuild $projectPath `
            /p:Configuration=Release `
            /p:WebPublishMethod=FileSystem `
            /p:DeleteExistingFiles=True `
            /p:PublishUrl=publish

      # Verify publish output
      - name: Verify publish folder
        shell: pwsh
        run: |
          if (Test-Path publish) {
            Write-Host "✅ Publish folder exists"
            dir publish -Recurse
          } else {
            Write-Host "❌ Publish folder NOT found"
            exit 1
          }

      # Upload publish folder as artifact
      - name: Upload Published Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: WebApp-Published
          path: publish/**
          if-no-files-found: error
